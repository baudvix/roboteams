//SLAVE
#define BT_CONN 1
#define INBOX 5
#define OUTBOX 1

string typ;
int id;

sub BTCheck(int conn) // läuft :)
{
 if(!BluetoothStatus(conn)==NO_ERR)
 {
  TextOut(5,LCD_LINE2,"Error");
  Wait(1000);
  //Stop(true);
 }
}

sub splitMsg(string msg) //klappt noch nicht ganz wie geplant, nachbesserung nötig
{
 typ = SubStr(msg,0,1);
 id = StrToNum(SubStr(msg,2,1));
}

sub checkInbox() // todo
{
 string in;
 int lcd = 8;
 while(true)
 {
  if(lcd<0){lcd = 8; TextOut(0,0,"",DRAW_OPT_CLEAR_WHOLE_SCREEN);}
  ReceiveRemoteString(INBOX, true, in);
  if(StrLen (in) != 0)
  {
   TextOut(0,lcd--*8,in);
   splitMsg(in);
   if(typ == "m")
   {
    string tmp;
    tmp = StrCat("r;", NumToStr(id),";response");
    TextOut(0,lcd--*8,tmp);
    SendResponseString(OUTBOX,tmp);
   }
  }
  else
  {
   TextOut(0,lcd--*8,"leer");
  }
  Wait(1000);
 }
}

task main()
{
 BTCheck(0); //check master connection
 checkInbox();
}
